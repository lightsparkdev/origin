name: "Create Release PR"

on:
  workflow_dispatch:
  # Temporary: run on PRs that modify this workflow for validation
  pull_request:
    paths:
      - ".github/workflows/release.yaml"
      - ".github/scripts/generate-changelog.py"

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Collect changes since last release
        id: changes
        run: |
          OLD_VERSION=$(node -p "require('./package.json').version")
          echo "old_version=$OLD_VERSION" >> "$GITHUB_OUTPUT"

          # Collect PR merge commit messages since last tag
          MERGES=$(git log v${OLD_VERSION}..HEAD --merges --pretty=format:"%s" || true)

          # Fall back to non-merge commits if no merges
          if [ -z "$MERGES" ]; then
            MERGES=$(git log v${OLD_VERSION}..HEAD --pretty=format:"%s" --no-merges | head -30)
          fi

          # Also collect the diff stat for context
          DIFFSTAT=$(git diff v${OLD_VERSION}..HEAD --stat | tail -1)

          # Write to env files for the next step
          {
            echo "COMMITS<<COMMITS_EOF"
            echo "$MERGES"
            echo "COMMITS_EOF"
          } >> "$GITHUB_ENV"

          {
            echo "DIFFSTAT<<DIFFSTAT_EOF"
            echo "$DIFFSTAT"
            echo "DIFFSTAT_EOF"
          } >> "$GITHUB_ENV"

      - name: Determine version bump and generate changelog
        id: ai
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OLD_VERSION: ${{ steps.changes.outputs.old_version }}
        run: python3 .github/scripts/generate-changelog.py

      # Skip the remaining steps on PR runs (just validate the AI step works)
      - name: Bump version
        if: github.event_name == 'workflow_dispatch'
        id: bump
        run: |
          npm version ${{ steps.ai.outputs.version_bump }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Update changelog
        if: github.event_name == 'workflow_dispatch'
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"

          # Replace the AI's placeholder version with the actual bumped version
          sed -i "s/→ [0-9]*\.[0-9]*\.[0-9]*/→ ${NEW_VERSION}/" /tmp/changelog_entry.md

          if [ -f CHANGELOG.md ]; then
            # Insert after the title line
            {
              head -1 CHANGELOG.md
              echo ""
              cat /tmp/changelog_entry.md
              echo ""
              tail -n +2 CHANGELOG.md
            } > /tmp/CHANGELOG.md
            mv /tmp/CHANGELOG.md CHANGELOG.md
          else
            {
              echo "# Changelog"
              echo ""
              cat /tmp/changelog_entry.md
            } > CHANGELOG.md
          fi

      - name: Create release branch and PR
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OLD_VERSION="${{ steps.changes.outputs.old_version }}"
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          VERSION_BUMP="${{ steps.ai.outputs.version_bump }}"
          BRANCH="release/v${NEW_VERSION}"

          git checkout -b "$BRANCH"
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "v${NEW_VERSION}"
          git push -u origin "$BRANCH"

          CHANGELOG_ENTRY=$(cat /tmp/changelog_entry.md)

          gh pr create \
            --title "v${NEW_VERSION}" \
            --body "$(cat <<EOF
          ## Release v${NEW_VERSION}

          **Version bump:** ${VERSION_BUMP} (${OLD_VERSION} → ${NEW_VERSION})

          ### Changes

          ${CHANGELOG_ENTRY}

          ---

          Merging this PR will publish \`@lightsparkdev/origin@${NEW_VERSION}\` to npm.
          EOF
          )"
